---
title: Stimulus randomization
author: Dan Yurovsky
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: false
    number_sections: false
    theme: lumen
    toc_float: false
    code_folding: show 
---


```{r setup, include=FALSE}
# load packages
library(knitr)
library(here)
library(janitor)
library(tidyverse)

opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, 
               error = FALSE, cache = FALSE, tidy = FALSE)

theme_set(theme_classic(base_size = 16))
```

```{r read-data}
stim_table <- read_csv(here("stimuli/stimuli_table.csv"))
```

Constraints:

*  every participant sees all 10 targets once

*  1/2 first round 1/2 last around

*  1/2 child, 1/2 parent

* at least 2 judgments

*  each from a different subject pair

```{r setup-stims}
stims <- stim_table %>%
  group_by(subid, target) %>%
  arrange(trial) %>%
  mutate(occurrence = 1:n()) 

nested_stims <- stims %>%
  group_by(occurrence, person, target) %>%
  nest() %>%
  rowwise() %>%
  mutate(rows = nrow(data)) %>%
  ungroup()
```

```{r randomize}
subjs <- tibble()

randomize <- function() {
  
  for(i in 1: (floor(nrow(stims) / 10))) {
    
    subj <- nested_stims %>%
      select(-data) %>%
      group_by(occurrence) %>%
      sample_n(5, weight = rows) %>%
      select(-rows)
    
    subj_data <- subj %>%
      inner_join(stims, by = c("target", "person", "occurrence")) %>%
      group_by(target, person, occurrence) %>%
      sample_n(1)
    
    stims <<- anti_join(stims, subj_data, 
                        by = c("audio", "subid", "trial", "target", "leftpic", 
                               "rightpic", "correct", "person", "occurrence"))
    
    nested_stims <-  stims %>%
    group_by(occurrence, person, target) %>%
    nest() %>%
    rowwise() %>%
    mutate(rows = nrow(data)) %>%
    ungroup()
    
    subjs <<- bind_rows(subjs, subj_data %>% mutate(subject = i))
  }
}
```

```{r out}
try(randomize(), silent = T)

write_csv(subjs, here("output/random_stims.csv"))
```

